<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Middleware | Redux</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.2.0">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../../gitbook/style.css">
    
    

        
    
    
    <link rel="next" href="../../docs/advanced/AsyncActions.html" />
    
    
    <link rel="prev" href="../../docs/advanced/index.html" />
    

        
    </head>
    <body>
        
        
    <div class="book" data-level="3.1" data-basepath="../.." data-revision="Fri Aug 14 2015 17:40:22 GMT+0300 (MSK)">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
        
        
        

        

        
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Read Me
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="docs/introduction/index.html">
            
                
                    <a href="../../docs/introduction/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Introduction
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="docs/introduction/Motivation.html">
            
                
                    <a href="../../docs/introduction/Motivation.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        Motivation
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="docs/introduction/ThreePrinciples.html">
            
                
                    <a href="../../docs/introduction/ThreePrinciples.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        Three Principles
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="docs/introduction/PriorArt.html">
            
                
                    <a href="../../docs/introduction/PriorArt.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                        Prior Art
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="docs/introduction/Ecosystem.html">
            
                
                    <a href="../../docs/introduction/Ecosystem.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                        Ecosystem
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="docs/introduction/Examples.html">
            
                
                    <a href="../../docs/introduction/Examples.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.5.</b>
                        
                        Examples
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="docs/basics/index.html">
            
                
                    <a href="../../docs/basics/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Basics
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="docs/basics/Actions.html">
            
                
                    <a href="../../docs/basics/Actions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Actions
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="docs/basics/Reducers.html">
            
                
                    <a href="../../docs/basics/Reducers.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        Reducers
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="docs/basics/Store.html">
            
                
                    <a href="../../docs/basics/Store.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                        Store
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="docs/basics/DataFlow.html">
            
                
                    <a href="../../docs/basics/DataFlow.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.4.</b>
                        
                        Data Flow
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="docs/basics/UsageWithReact.html">
            
                
                    <a href="../../docs/basics/UsageWithReact.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.5.</b>
                        
                        Usage with React
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="docs/basics/ExampleTodoList.html">
            
                
                    <a href="../../docs/basics/ExampleTodoList.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.6.</b>
                        
                        Example: Todo List
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="docs/advanced/index.html">
            
                
                    <a href="../../docs/advanced/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Advanced
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="3.1" data-path="docs/advanced/Middleware.html">
            
                
                    <a href="../../docs/advanced/Middleware.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        Middleware
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="docs/advanced/AsyncActions.html">
            
                
                    <a href="../../docs/advanced/AsyncActions.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        Async Actions
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="docs/advanced/AsyncFlow.html">
            
                
                    <a href="../../docs/advanced/AsyncFlow.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                        Async Flow
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.4" >
            
            <span><b>3.4.</b> Usage with React Router</span>
            
            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="docs/advanced/ExampleRedditAPI.html">
            
                
                    <a href="../../docs/advanced/ExampleRedditAPI.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.5.</b>
                        
                        Example: Reddit API
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.6" >
            
            <span><b>3.6.</b> Next Steps</span>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="docs/recipes/index.html">
            
                
                    <a href="../../docs/recipes/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Recipes
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1" data-path="docs/recipes/MigratingToRedux.html">
            
                
                    <a href="../../docs/recipes/MigratingToRedux.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                        Migrating to Redux
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="docs/recipes/ReducingBoilerplate.html">
            
                
                    <a href="../../docs/recipes/ReducingBoilerplate.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.2.</b>
                        
                        Reducing Boilerplate
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.3" >
            
            <span><b>4.3.</b> Server Rendering</span>
            
            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="docs/recipes/ComputingDerivedData.html">
            
                
                    <a href="../../docs/recipes/ComputingDerivedData.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.4.</b>
                        
                        Computing Derived Data
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="docs/recipes/WritingTests.html">
            
                
                    <a href="../../docs/recipes/WritingTests.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.5.</b>
                        
                        Writing Tests
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5" data-path="docs/Troubleshooting.html">
            
                
                    <a href="../../docs/Troubleshooting.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Troubleshooting
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="docs/Glossary.html">
            
                
                    <a href="../../docs/Glossary.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        Glossary
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="docs/api/index.html">
            
                
                    <a href="../../docs/api/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                        API Reference
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="7.1" data-path="docs/api/createStore.html">
            
                
                    <a href="../../docs/api/createStore.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.1.</b>
                        
                        createStore
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="7.2" data-path="docs/api/Store.html">
            
                
                    <a href="../../docs/api/Store.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.2.</b>
                        
                        Store
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="7.3" data-path="docs/api/combineReducers.html">
            
                
                    <a href="../../docs/api/combineReducers.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.3.</b>
                        
                        combineReducers
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="7.4" data-path="docs/api/applyMiddleware.html">
            
                
                    <a href="../../docs/api/applyMiddleware.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.4.</b>
                        
                        applyMiddleware
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="7.5" data-path="docs/api/bindActionCreators.html">
            
                
                    <a href="../../docs/api/bindActionCreators.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.5.</b>
                        
                        bindActionCreators
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="7.6" data-path="docs/api/compose.html">
            
                
                    <a href="../../docs/api/compose.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.6.</b>
                        
                        compose
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                Published with GitBook
            </a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Table of Contents"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Font Settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Share"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">
                    Share on Twitter
                </button>
                <button type="button" data-sharing="google-plus" class="button">
                    Share on Google
                </button>
                <button type="button" data-sharing="facebook" class="button">
                    Share on Facebook
                </button>
                <button type="button" data-sharing="weibo" class="button">
                    Share on Weibo
                </button>
                <button type="button" data-sharing="instapaper" class="button">
                    Share on Instapaper
                </button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Google"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Twitter"><i class="fa fa-twitter"></i></a>
    
    
    


    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../" >Redux</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="middleware">Middleware</h1>
<p>If you used server-side libraries like <a href="http://expressjs.com/" target="_blank">Express</a> and <a href="http://koajs.com/" target="_blank">Koa</a>, you are familiar with a concept of <em>middleware</em>. In these frameworks, middleware is some code you can put between the framework receiving a request, and framework generating a response. For example, Express or Koa middleware may add CORS headers, logging, compression, and more. The best feature of middleware is that it&#x2019;s composable in a chain. You can use multiple independent third-party middleware in a single project.</p>
<p>Redux middleware solves different problems than Express or Koa middleware, but in a conceptually similar way. <strong>It provides a third-party extension point between dispatching an action, and the moment it reaches the store.</strong> People use Redux middleware for logging, crash reporting, talking to an asynchronous API, routing, and more.</p>
<p>This article is divided in an in-depth intro to help you grok the concept, and <a href="#seven-examples">a few practical examples</a> to show the power of middleware at the very end. You may find it helpful to switch back and forth between them, as you flip between feeling bored and inspired.</p>
<blockquote>
<h5 id="note-for-the-impatient">Note for the Impatient</h5>
<p>You will find some practical advice on using middleware for asynchronous actions <a href="AsyncActions.html">in the next section</a>. However we strongly advise you to resist the urge to skip this article.</p>
<p>Middleware is the most &#x201C;magical&#x201D; part of Redux you are likely to encounter. Learning how it works and how to write your own is the best investment you can make into your productivity using Redux.</p>
<p>If you&#x2019;re really impatient, skip ahead to <a href="#seven-examples">seven examples</a> and come back.</p>
</blockquote>
<h2 id="understanding-middleware">Understanding Middleware</h2>
<p>While middleware can be used for a variety of things, including asynchronous API calls, it&#x2019;s really important that you understand where it comes from. We&#x2019;ll guide you through the thought process leading to middleware, by using logging and crash reporting as examples.</p>
<h3 id="problem-logging">Problem: Logging</h3>
<p>One of the benefits of Redux is that it makes state changes predictable and transparent. Every time an action is dispatched, the new state is computed and saved. The state cannot change by itself, it can only change as a consequence of a specific action.</p>
<p>Wouldn&#x2019;t it be nice if we logged every action that happens in the app, together with the state computed after it? When something goes wrong, we can look back at our log, and figure out which action corrupted the state.</p>
<p><img src="http://i.imgur.com/BjGBlES.png" width="70%"></p>
<p>How do we approach this with Redux?</p>
<h3 id="attempt-1-logging-manually">Attempt #1: Logging Manually</h3>
<p>The most na&#xEF;ve solution is just to log the action and the next state yourself every time you call <a href="../api/Store.html#dispatch"><code>store.dispatch(action)</code></a>. It&#x2019;s not really a solution, but just a first step towards understanding the problem.</p>
<blockquote>
<h5 id="note">Note</h5>
<p>If you&#x2019;re using <a href="https://github.com/gaearon/react-redux" target="_blank">react-redux</a> or similar bindings, you likely won&#x2019;t have direct access to the store instance in your components. For the next few paragraphs, just assume you pass the store down explicitly.</p>
</blockquote>
<p>Say, you call this when creating a todo:</p>
<pre><code class="lang-js">store.dispatch(addTodo(<span class="hljs-string">&apos;Use Redux&apos;</span>));
</code></pre>
<p>To log the action and state, you can change it to something like this:</p>
<pre><code class="lang-js"><span class="hljs-keyword">let</span> action = addTodo(<span class="hljs-string">&apos;Use Redux&apos;</span>);

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;dispatching&apos;</span>, action);
store.dispatch(action);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;next state&apos;</span>, store.getState());
</code></pre>
<p>This produces the desired effect, but you wouldn&#x2019;t want to do it every time.</p>
<h3 id="attempt-2-wrapping-dispatch">Attempt #2: Wrapping Dispatch</h3>
<p>You can extract logging into a function:</p>
<pre><code class="lang-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dispatchAndLog</span>(<span class="hljs-params">store, action</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;dispatching&apos;</span>, action);
  store.dispatch(action);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;next state&apos;</span>, store.getState());
}
</code></pre>
<p>You can then use it everywhere instead of <code>store.dispatch()</code>:</p>
<pre><code class="lang-js">dispatchAndLog(store, addTodo(<span class="hljs-string">&apos;Use Redux&apos;</span>));
</code></pre>
<p>We could end this here, but it&#x2019;s not very convenient to import a special function every time.</p>
<h3 id="attempt-3-monkeypatching-dispatch">Attempt #3: Monkeypatching Dispatch</h3>
<p>What if we just replace the <code>dispatch</code> function on the store instance? Redux store is just a plain object with <a href="../api/Store.html">a few methods</a>, and we&#x2019;re writing JavaScript, so we can just monkeypatch the <code>dispatch</code> implementation:</p>
<pre><code class="lang-js"><span class="hljs-keyword">let</span> next = store.dispatch;
store.dispatch = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dispatchAndLog</span>(<span class="hljs-params">action</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;dispatching&apos;</span>, action);
  <span class="hljs-keyword">let</span> result = next(action);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;next state&apos;</span>, store.getState());
  <span class="hljs-keyword">return</span> result;
};
</code></pre>
<p>This is already closer to what we want!  No matter where we dispatch an action, it is guaranteed to be logged. Monkeypatching never feels right, but we can live with this for now.</p>
<h3 id="problem-crash-reporting">Problem: Crash Reporting</h3>
<p>What if we want to apply <strong>more then one</strong> such transformation to <code>dispatch</code>?</p>
<p>A different useful transformation that comes to my mind is reporting JavaScript errors in production. The global <code>window.onerror</code> event is not reliable because it doesn&#x2019;t provide stack information in some older browsers, which is crucial to understand why an error is happening.</p>
<p>Wouldn&#x2019;t it be useful if, any time an error is thrown as a result of dispatching an action, we would send it to a crash reporting service like <a href="https://getsentry.com/welcome/" target="_blank">Sentry</a> with the stack trace, the action that caused the error, and the current state? This way it&#x2019;s much easier to reproduce the error in development.</p>
<p>However, it is important that we keep logging and crash reporting separate. Ideally we want them to be different modules, potentially in different packages. Otherwise we can&#x2019;t have an ecosystem of such utilities. (Hint: we&#x2019;re slowly getting to what middleware is!)</p>
<p>If logging and crash reporting are separate utilities, they might look like this:</p>
<pre><code class="lang-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">patchStoreToAddLogging</span>(<span class="hljs-params">store</span>) </span>{
  <span class="hljs-keyword">let</span> next = store.dispatch;
  store.dispatch = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dispatchAndLog</span>(<span class="hljs-params">action</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;dispatching&apos;</span>, action);
    <span class="hljs-keyword">let</span> result = next(action);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;next state&apos;</span>, store.getState());
    <span class="hljs-keyword">return</span> result;
  };
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">patchStoreToAddCrashReporting</span>(<span class="hljs-params">store</span>) </span>{
  <span class="hljs-keyword">let</span> next = store.dispatch;
  store.dispatch = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dispatchAndReportErrors</span>(<span class="hljs-params">action</span>) </span>{
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> next(action);
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&apos;Caught an exception!&apos;</span>, err);
      Raven.captureException(err, {
        extra: {
          action,
          state: store.getState()
        }
      });
      <span class="hljs-keyword">throw</span> err;
    }
  };
}
</code></pre>
<p>If these functions are published as separate modules, we can later use them to patch our store:</p>
<pre><code class="lang-js">patchStoreToAddLogging(store);
patchStoreToAddCrashReporting(store);
</code></pre>
<p>Still, this isn&#x2019;t nice.</p>
<h3 id="attempt-4-hiding-monkeypatching">Attempt #4: Hiding Monkeypatching</h3>
<p>Monkeypatching is a hack. &#x201C;Replace any method you like&#x201D;, what kind of API is that? Let&#x2019;s figure out the essence of it instead. Previously, our functions replaced <code>store.dispatch</code>. What if they <em>returned</em> the new <code>dispatch</code> function instead?</p>
<pre><code class="lang-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logger</span>(<span class="hljs-params">store</span>) </span>{
  <span class="hljs-keyword">let</span> next = store.dispatch;

  <span class="hljs-comment">// Previously:</span>
  <span class="hljs-comment">// store.dispatch = function dispatchAndLog(action) {</span>

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dispatchAndLog</span>(<span class="hljs-params">action</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;dispatching&apos;</span>, action);
    <span class="hljs-keyword">let</span> result = next(action);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;next state&apos;</span>, store.getState());
    <span class="hljs-keyword">return</span> result;
  };
}
</code></pre>
<p>We could provide a helper inside Redux that would apply the actual monkeypatching as an implementation detail:</p>
<pre><code class="lang-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">applyMiddlewareByMonkeypatching</span>(<span class="hljs-params">store, middlewares</span>) </span>{
  middlewares = middlewares.slice();
  middlewares.reverse();

  <span class="hljs-comment">// Transform dispatch function with each middleware.</span>
  middlewares.forEach(middleware =&gt;
    store.dispatch = middleware(store)
  );
}
</code></pre>
<p>We could use it to apply multiple middleware like this:</p>
<pre><code class="lang-js">applyMiddlewareByMonkeypatching(store, [logger, crashReporter]);
</code></pre>
<p>However, it is still monkeypatching.<br>The fact that we hide it inside the library doesn&#x2019;t alter this fact.</p>
<h3 id="attempt-5-removing-monkeypatching">Attempt #5: Removing Monkeypatching</h3>
<p>Why do we even overwrite <code>dispatch</code>? Of course, to be able to call it later, but there&#x2019;s also another reason: so that every middleware can access (and call) the previously wrapped <code>store.dispatch</code>:</p>
<pre><code class="lang-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logger</span>(<span class="hljs-params">store</span>) </span>{
  <span class="hljs-comment">// Must point to the function returned by the previous middleware:</span>
  <span class="hljs-keyword">let</span> next = store.dispatch;

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dispatchAndLog</span>(<span class="hljs-params">action</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;dispatching&apos;</span>, action);
    <span class="hljs-keyword">let</span> result = next(action);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;next state&apos;</span>, store.getState());
    <span class="hljs-keyword">return</span> result;
  };
}
</code></pre>
<p>It is essential to chaining middleware!</p>
<p>If <code>applyMiddlewareByMonkeypatching</code> doesn&#x2019;t assign <code>store.dispatch</code> immediately after processing the first middleware, <code>store.dispatch</code> will keep pointing to the original <code>dispatch</code> function. Then the second middleware will also be bound to the original <code>dispatch</code> function.</p>
<p>But there&#x2019;s also a different way to enable chaining. The middleware could accept the <code>next()</code> dispatch function as a parameter instead of reading it from the <code>store</code> instance.</p>
<pre><code class="lang-js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logger</span>(<span class="hljs-params">store</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">wrapDispatchToAddLogging</span>(<span class="hljs-params">next</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dispatchAndLog</span>(<span class="hljs-params">action</span>) </span>{
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;dispatching&apos;</span>, action);
      <span class="hljs-keyword">let</span> result = next(action);
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;next state&apos;</span>, store.getState());
      <span class="hljs-keyword">return</span> result;
    };
  }
}
</code></pre>
<p>It&#x2019;s a <a href="http://knowyourmeme.com/memes/we-need-to-go-deeper" target="_blank">&#x201C;we need to go deeper&#x201D;</a> kind of moment, so it might take a while for this to make sense. The function cascade feels intimidating. ES6 arrow functions make this <a href="https://en.wikipedia.org/wiki/Currying" target="_blank">currying</a> easier on eyes:</p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> logger = store =&gt; next =&gt; action =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;dispatching&apos;</span>, action);
  <span class="hljs-keyword">let</span> result = next(action);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;next state&apos;</span>, store.getState());
  <span class="hljs-keyword">return</span> result;
};

<span class="hljs-keyword">const</span> crashReporter = store =&gt; next =&gt; action =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> next(action);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&apos;Caught an exception!&apos;</span>, err);
    Raven.captureException(err, {
      extra: {
        action,
        state: store.getState()
      }
    });
    <span class="hljs-keyword">throw</span> err;
  }
}
</code></pre>
<p><strong>This is exactly what Redux middleware looks like.</strong></p>
<p>Now middleware takes the <code>next()</code> dispatch function, and returns a dispatch function, which in turn serves as <code>next()</code> to the middleware to the left, and so on. It&#x2019;s still useful to have access to some store methods like <code>getState()</code>, so <code>store</code> stays available as the top-level argument.</p>
<h3 id="attempt-6-na%C3%AFvely-applying-the-middleware">Attempt #6: Na&#xEF;vely Applying the Middleware</h3>
<p>Instead of <code>applyMiddlewareByMonkeypatching()</code>, we could write <code>applyMiddleware()</code> that first obtains the final, fully wrapped <code>dispatch()</code> function, and returns a copy of the store using it:</p>
<pre><code class="lang-js"><span class="hljs-comment">// Warning: Na&#xEF;ve implementation!</span>
<span class="hljs-comment">// That&apos;s *not* Redux API.</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">applyMiddleware</span>(<span class="hljs-params">store, middlewares</span>) </span>{
  middlewares = middlewares.slice();
  middlewares.reverse();

  <span class="hljs-keyword">let</span> dispatch = store.dispatch;
  middlewares.forEach(middleware =&gt;
    dispatch = middleware(store)(dispatch)
  );

  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.assign({}, store, { dispatch });
}
</code></pre>
<p>The implementation of <a href="../api/applyMiddleware.html"><code>applyMiddleware()</code></a> that ships with Redux is similar, but <strong>different in three important aspects</strong>:</p>
<ul>
<li><p>It only exposes a subset of <a href="../api/Store.html">store API</a> to the middleware: <a href="../api/Store.html#dispatch"><code>dispatch(action)</code></a> and <a href="../api/Store.%0Amd#getState"><code>getState()</code></a>.</p>
</li>
<li><p>It does a bit of trickery to make sure that if you call <code>store.dispatch(action)</code> from your middleware instead of <code>next(action)</code>, the action will actually travel the whole middleware chain again, including the current middleware. This is useful for asynchronous middleware, as we will see <a href="AsyncActions.html">later</a>.</p>
</li>
<li><p>To ensure that you may only apply middleware once, it operates on <code>createStore()</code> rather than on <code>store</code> itself. Instead of <code>(store, middlewares) =&gt; store</code>, its signature is <code>(...middlewares) =&gt; (createStore) =&gt; createStore</code>.</p>
</li>
</ul>
<h3 id="the-final-approach">The Final Approach</h3>
<p>Given this middleware we just wrote:</p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> logger = store =&gt; next =&gt; action =&gt; {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;dispatching&apos;</span>, action);
  <span class="hljs-keyword">let</span> result = next(action);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;next state&apos;</span>, store.getState());
  <span class="hljs-keyword">return</span> result;
};

<span class="hljs-keyword">const</span> crashReporter = store =&gt; next =&gt; action =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> next(action);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&apos;Caught an exception!&apos;</span>, err);
    Raven.captureException(err, {
      extra: {
        action,
        state: store.getState()
      }
    });
    <span class="hljs-keyword">throw</span> err;
  }
}
</code></pre>
<p>Here&#x2019;s how to apply it to a Redux store:</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { createStore, combineReducers, applyMiddleware } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;redux&apos;</span>;

<span class="hljs-comment">// applyMiddleware takes createStore() and returns</span>
<span class="hljs-comment">// a function with a compatible API.</span>
<span class="hljs-keyword">let</span> createStoreWithMiddleware = applyMiddleware(
  logger,
  crashReporter
)(createStore);

<span class="hljs-comment">// Use it like you would use createStore()</span>
<span class="hljs-keyword">let</span> todoApp = combineReducers(reducers);
<span class="hljs-keyword">let</span> store = createStoreWithMiddleware(todoApp);
</code></pre>
<p>This is it! Now any actions dispatched to the store instance will flow through <code>logger</code> and <code>crashReporter</code>:</p>
<pre><code class="lang-js"><span class="hljs-comment">// Will flow through both logger and crashReporter middleware!</span>
store.dispatch(addTodo(<span class="hljs-string">&apos;Use Redux&apos;</span>));
</code></pre>
<h2 id="seven-examples">Seven Examples</h2>
<p>If your head boiled from reading the above section, imagine what it was like to write it. This part is meant to be a relaxation for you and me, and will help get your gears turning.</p>
<p>Each function below is a valid Redux middleware. They are not equally useful, but at least they are equally fun.</p>
<pre><code class="lang-js"><span class="hljs-comment">/**
 * Logs all actions and states after they are dispatched.
 */</span>
<span class="hljs-keyword">const</span> logger = store =&gt; next =&gt; action =&gt; {
  <span class="hljs-built_in">console</span>.group(action.type);
  <span class="hljs-built_in">console</span>.info(<span class="hljs-string">&apos;dispatching&apos;</span>, action);
  <span class="hljs-keyword">let</span> result = next(action);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;next state&apos;</span>, store.getState());
  <span class="hljs-built_in">console</span>.groupEnd(action.type);
  <span class="hljs-keyword">return</span> result;
};

<span class="hljs-comment">/**
 * Sends crash reports as state is updated and listeners are notified.
 */</span>
<span class="hljs-keyword">const</span> crashReporter = store =&gt; next =&gt; action =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> next(action);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&apos;Caught an exception!&apos;</span>, err);
    Raven.captureException(err, {
      extra: {
        action,
        state: store.getState()
      }
    });
    <span class="hljs-keyword">throw</span> err;
  }
}

<span class="hljs-comment">/**
 * Schedules actions with { meta: { delay: N } } to be delayed by N milliseconds.
 * Makes `dispatch` return a function to cancel the interval in this case.
 */</span>
<span class="hljs-keyword">const</span> timeoutScheduler = store =&gt; next =&gt; action =&gt; {
  <span class="hljs-keyword">if</span> (!action.meta || !action.meta.delay) {
    <span class="hljs-keyword">return</span> next(action);
  }

  <span class="hljs-keyword">let</span> intervalId = setTimeout(
    () =&gt; next(action),
    action.meta.delay
  );

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cancel</span>(<span class="hljs-params"></span>) </span>{
    clearInterval(intervalId);
  };
};

<span class="hljs-comment">/**
 * Schedules actions with { meta: { raf: true } } to be dispatched inside a rAF loop frame.
 * Makes `dispatch` return a function to remove the action from queue in this case.
 */</span>
<span class="hljs-keyword">const</span> rafScheduler = store =&gt; next =&gt; {
  <span class="hljs-keyword">let</span> queuedActions = [];
  <span class="hljs-keyword">let</span> frame = <span class="hljs-literal">null</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loop</span>(<span class="hljs-params"></span>) </span>{
    frame = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (queuedActions.length) {
        next(queuedActions.shift());
      }
    } <span class="hljs-keyword">finally</span> {
      maybeRaf();
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">maybeRaf</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (queuedActions.length &amp;&amp; !frame) {
      frame = requestAnimationFrame(loop);
    }
  }

  <span class="hljs-keyword">return</span> action =&gt; {
    <span class="hljs-keyword">if</span> (!action.meta || !action.meta.raf) {
      <span class="hljs-keyword">return</span> next(action);
    }

    queuedActions.push(action);
    maybeRaf();

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cancel</span>(<span class="hljs-params"></span>) </span>{
      queuedActions = queuedActions.filter(a =&gt; a !== action)
    };
  };
};

<span class="hljs-comment">/**
 * Lets you dispatch promises in addition to actions.
 * If the promise is resolved, its result will be dispatched as an action.
 * The promise is returned from `dispatch` so the caller may handle rejection.
 */</span>
<span class="hljs-keyword">const</span> vanillaPromise = store =&gt; next =&gt; action =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> action.then !== <span class="hljs-string">&apos;function&apos;</span>) {
    <span class="hljs-keyword">return</span> next(action);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(action).then(store.dispatch);
};

<span class="hljs-comment">/**
 * Lets you dispatch special actions with a { promise } field.
 *
 * This middleware will turn them into a single action at the beginning,
 * and a single success (or failure) action when the `promise` resolves.
 *
 * For convenience, `dispatch` will return the promise so the caller can wait.
 */</span>
<span class="hljs-keyword">const</span> readyStatePromise = store =&gt; next =&gt; action =&gt; {
  <span class="hljs-keyword">if</span> (!action.promise) {
    <span class="hljs-keyword">return</span> next(action)
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeAction</span>(<span class="hljs-params">ready, data</span>) </span>{
    <span class="hljs-keyword">let</span> newAction = <span class="hljs-built_in">Object</span>.assign({}, action, { ready }, data);
    <span class="hljs-keyword">delete</span> newAction.promise;
    <span class="hljs-keyword">return</span> newAction;
  }

  next(makeAction(<span class="hljs-literal">false</span>));
  <span class="hljs-keyword">return</span> action.promise.then(
    result =&gt; next(makeAction(<span class="hljs-literal">true</span>, { result })),
    error =&gt; next(makeAction(<span class="hljs-literal">true</span>, { error }))
  );
};

<span class="hljs-comment">/**
 * Lets you dispatch a function instead of an action.
 * This function will receive `dispatch` and `getState` as arguments.
 *
 * Useful for early exits (conditions over `getState()`), as well
 * as for async control flow (it can `dispatch()` something else).
 *
 * `dispatch` will return the return value of the dispatched function.
 */</span>
<span class="hljs-keyword">const</span> thunk = store =&gt; next =&gt; action =&gt;
  <span class="hljs-keyword">typeof</span> action === <span class="hljs-string">&apos;function&apos;</span> ?
    action(store.dispatch, store.getState) :
    next(action);


<span class="hljs-comment">// You can use all of them! (It doesn&#x2019;t mean you should.)</span>
<span class="hljs-keyword">let</span> createStoreWithMiddleware = applyMiddleware(
  rafScheduler,
  timeoutScheduler,
  thunk,
  vanillaPromise,
  readyStatePromise,
  logger,
  errorHandler
)(createStore);
<span class="hljs-keyword">let</span> todoApp = combineReducers(reducers);
<span class="hljs-keyword">let</span> store = createStoreWithMiddleware(todoApp);
</code></pre>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../../docs/advanced/index.html" class="navigation navigation-prev " aria-label="Previous page: Advanced"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../../docs/advanced/AsyncActions.html" class="navigation navigation-next " aria-label="Next page: Async Actions"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../../gitbook/app.js"></script>

    
    <script src="../../gitbook/plugins/gitbook-plugin-livereload/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
